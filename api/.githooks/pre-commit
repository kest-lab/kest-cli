#!/bin/bash
#
# Pre-commit hook to prevent committing binary files
# This helps keep the repository clean and fast
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîç Running pre-commit checks...${NC}"

# List of binary patterns to block
BINARY_PATTERNS=(
    "zgo"
    "server"
    "eogo"
    "*.exe"
    "*.dll"
    "*.so"
    "*.dylib"
)

# Check for large files (> 10MB)
MAX_FILE_SIZE=10485760  # 10MB in bytes

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

HAS_ERROR=0

for file in $STAGED_FILES; do
    # Skip if file doesn't exist (deleted)
    if [ ! -f "$file" ]; then
        continue
    fi

    # Check for binary files by name
    filename=$(basename "$file")
    for pattern in "${BINARY_PATTERNS[@]}"; do
        if [[ "$filename" == $pattern ]]; then
            echo -e "${RED}‚ùå ERROR: Attempting to commit binary file: $file${NC}"
            echo -e "${YELLOW}   Please add this file to .gitignore${NC}"
            HAS_ERROR=1
        fi
    done

    # Check file size
    filesize=$(wc -c < "$file" | tr -d ' ')
    if [ "$filesize" -gt "$MAX_FILE_SIZE" ]; then
        size_mb=$(echo "scale=2; $filesize / 1048576" | bc)
        echo -e "${RED}‚ùå ERROR: File too large (${size_mb}MB): $file${NC}"
        echo -e "${YELLOW}   Maximum allowed size is 10MB${NC}"
        echo -e "${YELLOW}   Consider using Git LFS for large files: https://git-lfs.github.com${NC}"
        HAS_ERROR=1
    fi

    # Check if file is binary (using file command)
    # Skip shell scripts and .githooks directory
    if [[ "$file" == .githooks/* ]]; then
        continue
    fi
    
    if file "$file" | grep -qE "executable|ELF|Mach-O" && ! file "$file" | grep -q "script"; then
        echo -e "${RED}‚ùå ERROR: Binary executable detected: $file${NC}"
        echo -e "${YELLOW}   Binary files should not be committed to the repository${NC}"
        HAS_ERROR=1
    fi
done

if [ $HAS_ERROR -eq 1 ]; then
    echo ""
    echo -e "${RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${RED}‚ùå Commit blocked! Please fix the issues above.${NC}"
    echo -e "${RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "${YELLOW}To bypass this check (not recommended):${NC}"
    echo -e "${YELLOW}  git commit --no-verify${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
exit 0
